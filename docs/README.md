# Lawlytics – Legal Document Chat (Next.js + Google Cloud)

Lawlytics is a Next.js application that lets users upload legal documents and chat with them using Retrieval-Augmented Generation (RAG) powered by Google Cloud. Documents are uploaded to Google Cloud Storage, parsed by Document AI, chunked and embedded with Vertex AI, stored in Firestore, and then used to ground answers generated by Gemini.

For a deep-dive into the chat-over-documents feature, see: `docs/LEGAL_CHAT.md`.

## Features

- Secure document upload to Google Cloud Storage (GCS)
- Text extraction via Document AI
- Chunking + embeddings with Vertex AI (`text-embedding-004`)
- Firestore storage for chunks, conversations, and messages
- Chat grounded on retrieved document chunks using `gemini-2.0-flash-001`
- Firebase Authentication (client) + Firebase Admin (server) for auth

## Tech Stack

- Next.js 15 (App Router) + TypeScript + React 19
- Tailwind CSS 4
- Google Cloud: Document AI, Vertex AI, Cloud Storage
- Firebase: Auth, Firestore, Admin SDK

Key dependencies (see `package.json`): `@google-cloud/documentai`, `@google-cloud/storage`, `@google-cloud/vertexai`, `firebase`, `firebase-admin`, `google-auth-library`.

## Architecture Overview

```mermaid
flowchart LR
  A[Client UI (Next.js)] -->|upload| B[/API: /api/upload/]
  B --> C[(GCS Bucket)]
  A -->|analyze| D[/API: /api/analyze/]
  D --> E[Document AI]
  D --> F[Vertex AI - Embeddings]
  D --> G[(Firestore: documentChunks)]
  A -->|create/list| H[/API: /api/conversations/]
  H --> G
  A -->|ask| I[/API: /api/chat/]
  I --> G
  I --> J[Vertex AI - Gemini]
  I --> G
```

Primary UI route: `src/app/chat/page.tsx`

Server routes:
- `src/app/api/upload/route.ts`
- `src/app/api/analyze/route.ts`
- `src/app/api/conversations/route.ts`
- `src/app/api/chat/route.ts`

Utilities:
- `src/utils/embeddings.ts` – Vertex AI embeddings REST helper
- `src/utils/similarity.ts` – cosine similarity + topK helpers
- `src/utils/vertexClient.ts` – Vertex AI generative client (Gemini)

More details in `docs/LEGAL_CHAT.md`.

## Environment Variables (.env)

You already maintain a comprehensive `.env` with Google Cloud and Firebase configuration. To run the legal chat system end-to-end, ensure the following exist. Items marked NEW are additions that may not be in older configs.

Google Cloud / Vertex AI:
- `GCP_PROJECT_ID=587742710924`
- `GCP_LOCATION=us`                   # Document AI location
- `GCP_VERTEX_LOCATION=us-central1`   # Vertex location
- `VERTEX_MODEL_ID=gemini-2.0-flash-001`
- `VERTEX_EMBEDDING_MODEL_ID=text-embedding-004`  # NEW
- `GCS_BUCKET_NAME=legal-doc-ai-uploads`
- `GCP_KEY_FILE=./upload-service.json`            # NEW (path to service account JSON)

Document AI:
- `GCP_PROCESSOR_ID=bc0db257f446ceff`

Firebase Admin (server):
- `NEXT_PUBLIC_FIREBASE_PROJECT_ID=lawlytics-abddd`
- `FIREBASE_CLIENT_EMAIL=...@lawlytics-abddd.iam.gserviceaccount.com`
- `FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"`  # Keep newline escapes
- `FIREBASE_DATABASE_URL=https://lawlytics-abddd.firebaseio.com`

Firebase (client – NEXT_PUBLIC):
- `NEXT_PUBLIC_FIREBASE_API_KEY=...`
- `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=lawlytics-abddd.firebaseapp.com`
- `NEXT_PUBLIC_FIREBASE_DATABASE_URL=https://lawlytics-abddd.firebaseio.com`
- `NEXT_PUBLIC_FIREBASE_PROJECT_ID=lawlytics-abddd`
- `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=lawlytics-abddd.appspot.com`
- `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=...`
- `NEXT_PUBLIC_FIREBASE_APP_ID=...`
- `NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=...` (optional)

Permissions notes:
- The service account referenced by `GCP_KEY_FILE` needs roles: Vertex AI User, Storage Object Admin, and Document AI API User.

## Quickstart

1) Install dependencies
```bash
npm install
```

2) Set up environment
- Create `.env.local` at the project root with the variables above (or ensure your existing `.env` includes the NEW ones).
- Place the service account JSON at the path referenced by `GCP_KEY_FILE`.

3) Start the dev server
```bash
npm run dev
# http://localhost:3000
```

4) Use the app
- Navigate to `/chat` to upload a file, analyze it, and start chatting.
- Sign in with Firebase Auth (the UI is included in the app).

## Project Scripts

From `package.json`:
- `npm run dev` – Start Next.js in development
- `npm run build` – Build for production
- `npm run start` – Start production server
- `npm run lint` – Lint the project

## API Summary

See `docs/LEGAL_CHAT.md` for full contracts. Highlights:
- `POST /api/upload` – multipart/form-data file upload. Requires Firebase ID token.
- `POST /api/analyze` – runs Document AI extraction, chunking, embeddings, and persists results.
- `GET /api/conversations` / `POST /api/conversations` – manage user conversations per document.
- `GET /api/chat?conversationId=...` / `POST /api/chat` – fetch messages and ask questions grounded in retrieved chunks.

## Security

- All API routes verify Firebase ID tokens via Admin SDK.
- Uploads are validated for type and size.
- Non-legal documents are rejected using heuristics + LLM checks during analysis.
- Server-side operations use service account credentials; client-side uses Firebase Auth and reads are scoped to the user.

## Troubleshooting

- 401 Unauthorized: ensure the client includes `Authorization: Bearer <ID token>` using `user.getIdToken()`.
- Missing `GCP_KEY_FILE`: confirm the path is correct and readable at runtime.
- Firestore permission errors: configure security rules to allow users to read their own docs; server writes via Admin SDK.
- Vertex/DocAI permission issues: grant the necessary roles to the service account.

## Deployment

- Provide the same `.env` variables in your hosting environment (Vercel/Cloud Run/etc.).
- Ensure the service account JSON is available—prefer mounting as a secret or using runtime-managed credentials.
- Confirm egress is allowed to Google APIs.

## Useful Paths

- Pages and routes: `src/app/`
- Chat UI: `src/app/chat/page.tsx`
- API: `src/app/api/*/route.ts`
- Components: `src/components/`
- Contexts: `src/contexts/`

## License

Proprietary – for hackathon/demo use unless otherwise noted. Update this section with your preferred license.

